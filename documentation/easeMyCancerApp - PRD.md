# Product Requirements Document — Next.js app with Google Sheets backend

**Title:** SheetForms — Dynamic form + PDF generator using Google Sheets

**Author:** Generated for Yash

**Date:** 2025-09-22

---

## 1. Executive summary
A lightweight Next.js application that treats Google Sheets as the primary data store. The app must support multiple Google Sheets across single or multiple Google accounts, support frequent schema changes via an easy (no-code) schema editor, present autogenerated user-facing forms (driven by sheet schema), allow users to submit data that writes back to sheets, and render selected sheet rows as formatted PDF documents. Authentication and role-based access control are handled by Clerk. The UI should be implemented with the shadcn UI system and Tailwind. The architecture must allow the Google Sheets connector to be easily replaced later by another backend (e.g., a database).

## 2. Goals & success metrics
**Primary goals**
- Make Google Sheets feel like a dynamic schema-driven backend, with the flexibility to swap it out for a database later.
- Enable non-technical users (nutritionists, instructors, admins) to modify sheet schema and immediately update user forms without code.
- Provide robust PDF generation from a selected sheet row with customizable templates.
- Support both client-side PDF generation (MVP) and server-side PDF generation (scalable option for later).
- Secure user auth + role-based access via Clerk.

**Success metrics (sample)**
- Time for a non-technical user to add/remove a sheet column and see form updated: < 5 minutes.
- PDF generation accuracy (layout + data) >= 99% for targeted templates.
- 99.9% uptime for core flows (read/write + PDF generation).
- User satisfaction score (pilot group) >= 4/5.

## 3. Users & roles
- **End users** — clients who will fill forms and view/download PDFs.
- **Nutritionists / Yoga instructors** — domain experts who create and manage forms/templates and view client records.
- **Admin** — full access: connect Google accounts/sheets, manage users/roles, configure global settings.
- **Developers / Integrators** — extend connectors, add templates, or advanced automations.

## 4. Core features (functional requirements)

### 4.1 Connector service (replaceable design)
- Abstract connector service layer: expose a consistent API for CRUD operations (read schema, read rows, append row, update row, delete row).
- First implementation: Google Sheets connector (OAuth2, Sheets API).
- Later implementation: Database connector (e.g., MongoDB, PostgreSQL).
- Maintain dependency inversion: UI and schema service interact only with the connector interface, not its concrete implementation.
- Each connector responsible for mapping between external data and internal schema metadata.

### 4.2 Flexible schema management (no-code editor)
- For each sheet, present a visual schema editor that reads the first row or an admin-defined header mapping.
- Allow admins/non-technical users to: add/remove fields (logical columns), rename fields, change field types (text, number, enum, date, boolean, file/attachment link), set required/optional, set validation rules (min/max, regex), and configure placeholder/help text.
- Support field-level metadata: label, description, display order, visibility per role, default value, read-only flag, mapping to actual column (A, B, C or header name).
- Provide versioning: every schema change creates a version; allow rollback to previous schema.
- Auto-detect new columns from Google Sheets and surface them as suggestions to add to schema.

### 4.3 Dynamic form rendering & submission
- For each sheet schema, dynamically render forms for end users based on the schema metadata.
- Support conditional visibility / dependency rules (e.g., show `pregnancy` only if `sex` == 'female').
- Validate inputs client-side according to schema rules; perform server-side validation before writing to sheet.
- On submit, append (or upsert) row(s) to the selected sheet. Provide optimistic UI with clear success/failure feedback.
- Support draft/save-as and edit-existing-record flows via row-id (or marker column).

### 4.4 PDF generation from sheet row
- Allow role-based users to select a single row (or set of rows) and generate a printable, formatted PDF.
- **Two-way door design:**
  - **MVP:** Client-side PDF generation using HTML-to-PDF libraries (e.g., jsPDF, html2pdf.js). Faster, lower-cost, minimal infra.
  - **Scalable option:** Server-side rendering of HTML → PDF for reliability (headless Chromium / puppeteer or Playwright), with optional queue for heavy workloads.
- PDF engine features:
  - Use an HTML template system (Mustache/Handlebars/React templates) to map schema fields to template placeholders.
  - Offer a template editor (WYSIWYG or code) for admins/nutritionists to customize layout, fonts, header/footer, logo, and repeatable sections.
  - Support QR-code insertion, images (if sheet contains image URLs), and simple charts pulled from data.
  - Provide export options: download PDF or open in new tab.
- Generated PDFs are not stored by default. Optionally add storage (S3, GCS) later.

### 4.5 Authentication & authorization
- Use Clerk for auth (signup/signin, magic links, social providers if needed).
- Map Clerk users to roles. Use role claims to control sheet access and UI visibility.
- Admin UI to manage role assignments and external account connections.

### 4.6 Admin dashboard
- Manage connected Google accounts and sheets.
- Visual schema editor and version history.
- Template manager for PDF templates.
- Audit logs: user sign-ins, schema changes, record creates/edits, PDF generation events.
- Usage & quotas: monitor reads/writes and PDF generation counts to avoid Google API quota issues.

### 4.7 Notifications & integrations (optional MVP+)
- Email notifications on form submissions or PDF generation.
- Webhooks for external systems when a row is created/updated.
- Slack/Teams notifications for admin alerts.

## 5. Non-functional requirements
- **Platform:** Next.js (TypeScript), React with shadcn UI (Tailwind). Use App Router recommended.
- **Scalability:** Support hundreds of connected sheets and thousands of row operations per day. Design for easy connector swap (Google Sheets → MongoDB).
- **Latency:** Read/write operations to sheets should be < 2s in typical cases (depends on Google API latency).
- **Security:** Enforce least privilege for Google access; encrypt stored OAuth tokens; use Clerk-managed sessions; CSRF protection; rate limiting for endpoints.
- **Reliability:** Retries for transient Google API errors; durable job queue for PDF generation if using server-side option.
- **Observability:** Structured logs, metrics for API calls, PDF queue, errors.

## 6. Architecture & components
- **Frontend (Next.js + shadcn):** dynamic UI, form rendering, template editor, admin console.
- **Backend (Next.js serverless / Node API):** API routes to orchestrate connector service calls, schema service, auth/roles enforcement, optional PDF generation endpoint.
- **Connector service:** Abstract interface for data operations. Implemented initially with Google Sheets API, later swappable with MongoDB or other DBs.
- **Schema service:** Stores schema metadata per sheet (database: **MongoDB** chosen for flexibility with dynamic schema changes). Handles versioning and mapping to external connector fields.
- **PDF service:** Client-side PDF generation for MVP; optional server-side PDF worker/service using puppeteer. Pluggable for future scaling.
- **Storage:** MongoDB for metadata. Optional blob storage (S3, GCS) if later storing PDFs.
- **Job queue (future):** for long-running server-side jobs (PDF creation, large syncs).

## 7. Data model (high level)
- **ConnectedSource:** id, type (sheet, db), sourceId, sheetName/collectionName, connectedAccountId, config (sync settings), lastSyncedAt
- **SchemaDefinition:** id, connectedSourceId, version, fields: [{key, label, type, required, validationRules, columnRef, visibleToRoles}], createdBy, createdAt
- **UserRecordMapping:** externalRowId, internalId, linkedUserId, createdAt, updatedAt
- **PdfTemplate:** id, name, htmlTemplate, css, ownerId, defaultFlag
- **AuditLog:** actorId, actionType, targetId, details, timestamp

## 8. UX notes and UI flows
- **Onboarding:** Admin connects Google account -> selects spreadsheets -> app scans and suggests schema (based on header row) -> admin refines schema -> assigns template(s) and roles.
- **Form flow for end-user:** Sign in -> select or land on assigned form -> fill fields with inline help/validation -> submit -> success page + option to download PDF.
- **Schema editor:** Drag-and-drop ordering, field editing modal, preview toggle to see how forms will look.

## 9. Implementation plan & MVP scope
**MVP (4–8 weeks, small team)**
- Connector service with Google Sheets implementation, abstracted behind interface
- Schema auto-detect + no-code schema editor (basic types + validation) backed by MongoDB
- Dynamic form rendering and submit -> append row
- Clerk-based auth and role mapping
- Client-side PDF generation using default HTML template
- Basic admin dashboard: connected sources, schema list, template upload

**MVP+ (after core validated)**
- Multi-account connectors, service account support
- Schema versioning + rollback UI
- Template WYSIWYG editor, QR codes, images and charts in PDFs
- Server-side PDF generation with optional queue
- Notifications & webhooks
- Audit logs and usage dashboard

## 10. Security & compliance
- Store OAuth refresh tokens encrypted at rest. Rotate credentials periodically.
- Principle of least privilege: use granular scopes for Google API (readonly vs write) according to needs.
- Ensure PDF generation avoids injection: sanitize template inputs and escapes.
- GDPR considerations: allow data export/deletion per user; document retention policies.

## 11. Operational considerations
- Google API quotas: track and surface usage; allow admins to configure caching or batch writes.
- Backups: periodically snapshot MongoDB metadata and optionally cache sheet exports.
- Error recovery: failed writes or PDF jobs should be retried and visible to admins.

## 12. Acceptance criteria (sample)
- A non-admin user can authenticate with Clerk and fill a form derived from a connected sheet schema and have the row appended in Google Sheets.
- An admin can connect a Google account, select a sheet, use the schema editor to set types and required fields, and see the form preview.
- A PDF can be generated from a selected row on the client side and matches the template fields with correct values.

## 13. Risks & mitigation
- **Google API rate/quotas:** implement batching, caching, and backoff; inform admins; use service accounts where possible.
- **Schema drift:** guard with schema versioning and preview before applying to live forms.
- **Non-technical user errors:** include validation, previews, and undo (version rollback).
- **PDF rendering inconsistencies:** client-side libraries may vary across browsers; provide server-side option later.

## 14. Open questions
1. Expected timing for DB migration (MongoDB full backend)?
2. Will some sheets/collections need column-level encryption or sensitive PII handling?
3. Expected scale of concurrent PDF generations (to decide when server-side PDF is necessary).
4. Is offline / mobile-first experience required for end users (e.g., field agents)?

## 15. Next steps
- Validate MVP scope and priorities with stakeholders.
- Create a tech spike to evaluate connector service abstraction and client-side PDF approach.
- Design initial UI components (schema editor + dynamic form) using shadcn and Tailwind and produce click-through prototypes.

---

*End of document.*

